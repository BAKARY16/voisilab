import { useState, useEffect } from 'react';
import { Table, TableBody, TableCell, TableContainer, TableHead, TableRow, IconButton, Chip, Paper, Select, MenuItem } from '@mui/material';
import { DeleteOutlined } from '@ant-design/icons';
import MainCard from 'components/MainCard';
import { contactsService } from 'api/voisilab';

export default function ContactsPage() {
  const [contacts, setContacts] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => { loadContacts(); }, []);

  const loadContacts = async () => {
    try {
      setLoading(true);
      const result = await contactsService.getAll();
      setContacts(result.data || []);
    } catch (error) {
      console.error('Error:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleStatusChange = async (id, status) => {
    try {
      await contactsService.updateStatus(id, status);
      loadContacts();
    } catch (error) {
      console.error('Error:', error);
    }
  };

  const handleDelete = async (id) => {
    if (!window.confirm('Supprimer?')) return;
    try {
      await contactsService.delete(id);
      loadContacts();
    } catch (error) {
      console.error('Error:', error);
    }
  };

  return (
    <MainCard title="Messages de contact">
      <TableContainer component={Paper}>
        <Table>
          <TableHead>
            <TableRow>
              <TableCell>Nom</TableCell>
              <TableCell>Email</TableCell>
              <TableCell>Sujet</TableCell>
              <TableCell>Statut</TableCell>
              <TableCell>Date</TableCell>
              <TableCell>Actions</TableCell>
            </TableRow>
          </TableHead>
          <TableBody>
            {loading ? <TableRow><TableCell colSpan={6} align="center">Chargement...</TableCell></TableRow> : contacts.map((contact) => (
              <TableRow key={contact.id}>
                <TableCell>{contact.name}</TableCell>
                <TableCell>{contact.email}</TableCell>
                <TableCell>{contact.subject}</TableCell>
                <TableCell>
                  <Select value={contact.status} onChange={(e) => handleStatusChange(contact.id, e.target.value)} size="small">
                    <MenuItem value="unread">Non lu</MenuItem>
                    <MenuItem value="read">Lu</MenuItem>
                    <MenuItem value="replied">Répondu</MenuItem>
                    <MenuItem value="archived">Archivé</MenuItem>
                  </Select>
                </TableCell>
                <TableCell>{new Date(contact.created_at).toLocaleDateString('fr-FR')}</TableCell>
                <TableCell>
                  <IconButton onClick={() => handleDelete(contact.id)} color="error" size="small"><DeleteOutlined /></IconButton>
                </TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </TableContainer>
    </MainCard>
  );
}
